# ПО сервера

Сервер является базой данных на СУБД Postgres.


## Таблицы
* **users**(id, firstname, surname, middlename, expire, created) - список зарегистрированных пользовалетей
* **preregistred_user** (id, firstname, surname, middlename, birthday, email, register_type_id, login, created) - список пользователей, которым разрешена регистрация без дополнительного разрешения.
  * expire - время окончания действия возможности печати
* **logins**(id, user_id, register_type_id, login, password, created) - таблица связка, соединяет пользователя и его логины для входа с указанием типа регистрации.
* **approvals**(id, user_id, file, is_proved, expires, created) - разрешения на печать пользователей. Если пользователь среди предзарегистрированных, то запись создается автоматически при регистрации. Если пользователя нет среди предзарегистрированных, то запись появляется при подаче им заявки через личный кабинет, тогда заполнен аттрибут file. После проверки заявки создается новая запись с заполненными параметрами is_proved и expires. 
* **file**(id, pin, user_id, filetype_id, hash, size, file, created) - список загруженных файлов. 
* **file_options**(id,file_id,pages,count_per_list, twosided, created)
* **log**(id, created, issuer, user_id, file_id, log_type, message)


## Справочники
* **register_type**(id, name, description) - типы регистрации пользователей: профсоюзный билет, студенческий билет.
* **filetype**(id, extension, description) - разширения файлов, которые принимает система.
* **response_codes**(id, name, description) - списки кодов состояния показывает, был ли успешно выполнен определённый запрос. 
* **log_type**(id, name, description) - типы записей в логе
  * Работа с учетной записью: создание, подтверждение, автоматические подтверждение, редактирование, обновление, удаление
  * Работа с файлом: загрузка, обновление настроек, автоматическое удаление
  * Работа с терминалом: печать файла, нажатие на кнопку
  * Работа с ботом: нажатие на кнопку
  * Работа с сайтом: нажатие на кнопку


## Функции
* **is_preregistred**(register_type_id, user::preregistred_user) - проверяет, есть ли пользователь среди предварительно зарегистрированных. Возвращает код успешного выполнения и preregistred_user если хотя бы 2 поля совпадают. Иначе возвращает код ошибки.
* **is_registred**(register_type_id, login, user::user) - проверяет, есть ли пользователь среди зарегистрированных. Возвращает код успешного выполнения и user если login и хотя бы 1 поле совпадают. Иначе возвращает код ошибки.
* **add_file**(login, user::user, filetype_id, file::bytes) - добавляет файл, рассчитывает размер файла и MD5 hash, добавляет файл в БД, добаляет PIN для печати и возвращает код успешной загрузки, file_id и PIN. Возвращает код ошибки, если файл не удалось загрузить (например, неверный тип данных или неверные данные пользователя).
* **add_selfprinted_file**(login, user::user, filetype_id, size, hash) - добавляет файл, распечатываемый с терминала напрямую. 
* **add_file_options**(login, user::user, option::file_option) - добавляет опции печати к файлу
* **clear_files**(time) - удаляет все файлы, которые загружены до time через UPDATE 
* **delete_file**(login, user::user, file_id) - удаляет конкретный файл с сервера

